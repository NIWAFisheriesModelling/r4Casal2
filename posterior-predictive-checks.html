<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Posterior Predictive Checks | r4Casal2</title>
  <meta name="description" content="This book demonstrates how to use r4Casal2 to make your Casal2 experience better." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Posterior Predictive Checks | r4Casal2" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This book demonstrates how to use r4Casal2 to make your Casal2 experience better." />
  <meta name="github-repo" content="https://github.com/NIWAFisheriesModelling/r4Casal2" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Posterior Predictive Checks | r4Casal2" />
  
  <meta name="twitter:description" content="This book demonstrates how to use r4Casal2 to make your Casal2 experience better." />
  

<meta name="author" content="C.Marsh" />


<meta name="date" content="2022-05-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mcmc.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">r4Casal2</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcolme to <strong>r4Casal2</strong></a></li>
<li class="chapter" data-level="2" data-path="summariseinputs.html"><a href="summariseinputs.html"><i class="fa fa-check"></i><b>2</b> Summarise configuration inputs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="summariseinputs.html"><a href="summariseinputs.html#example-files"><i class="fa fa-check"></i><b>2.1</b> Example files</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="mpd-summaries.html"><a href="mpd-summaries.html"><i class="fa fa-check"></i><b>3</b> MPD summaries</a>
<ul>
<li class="chapter" data-level="3.1" data-path="mpd-summaries.html"><a href="mpd-summaries.html#single-model-output"><i class="fa fa-check"></i><b>3.1</b> Single Model Output</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="mpd-summaries.html"><a href="mpd-summaries.html#model-convergence"><i class="fa fa-check"></i><b>3.1.1</b> Model Convergence</a></li>
<li class="chapter" data-level="3.1.2" data-path="mpd-summaries.html"><a href="mpd-summaries.html#model-quantities"><i class="fa fa-check"></i><b>3.1.2</b> Model quantities</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="mpd-summaries.html"><a href="mpd-summaries.html#multiple-casal2-runs-with--i-or--s"><i class="fa fa-check"></i><b>3.2</b> Multiple Casal2 runs with -i or -s</a>
<ul>
<li class="chapter" data-level="" data-path="mpd-summaries.html"><a href="mpd-summaries.html#plotting-selectivities-1"><i class="fa fa-check"></i>Plotting selectivities</a></li>
<li class="chapter" data-level="" data-path="mpd-summaries.html"><a href="mpd-summaries.html#plotting-fits"><i class="fa fa-check"></i>Plotting Fits</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html"><i class="fa fa-check"></i><b>4</b> Comparing multiple MPD runs</a>
<ul>
<li class="chapter" data-level="4.1" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#read-in-models"><i class="fa fa-check"></i><b>4.1</b> Read in models</a></li>
<li class="chapter" data-level="4.2" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#compare-model-outputs"><i class="fa fa-check"></i><b>4.2</b> Compare model outputs</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#selectivities"><i class="fa fa-check"></i><b>4.2.1</b> selectivities</a></li>
<li class="chapter" data-level="4.2.2" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#derived-quantities"><i class="fa fa-check"></i><b>4.2.2</b> Derived quantities</a></li>
<li class="chapter" data-level="4.2.3" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#recruitment"><i class="fa fa-check"></i><b>4.2.3</b> Recruitment</a></li>
<li class="chapter" data-level="4.2.4" data-path="summarisemultipleinputs.html"><a href="summarisemultipleinputs.html#abundance-fits"><i class="fa fa-check"></i><b>4.2.4</b> Abundance fits</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="mcmc.html"><a href="mcmc.html"><i class="fa fa-check"></i><b>5</b> MCMC</a>
<ul>
<li class="chapter" data-level="5.1" data-path="mcmc.html"><a href="mcmc.html#read-in-models-1"><i class="fa fa-check"></i><b>5.1</b> Read in models</a></li>
<li class="chapter" data-level="5.2" data-path="mcmc.html"><a href="mcmc.html#compare-model-outputs-1"><i class="fa fa-check"></i><b>5.2</b> Compare model outputs</a></li>
<li class="chapter" data-level="5.3" data-path="mcmc.html"><a href="mcmc.html#better-ssb-plot-with-transparient-ribbons"><i class="fa fa-check"></i><b>5.3</b> better SSB plot with transparient ribbons</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="mcmc.html"><a href="mcmc.html#selectivities-1"><i class="fa fa-check"></i><b>5.3.1</b> selectivities</a></li>
<li class="chapter" data-level="5.3.2" data-path="mcmc.html"><a href="mcmc.html#derived-quantities-1"><i class="fa fa-check"></i><b>5.3.2</b> Derived quantities</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html"><i class="fa fa-check"></i><b>6</b> Posterior Predictive Checks</a>
<ul>
<li class="chapter" data-level="6.1" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#introduction"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#estimation"><i class="fa fa-check"></i><b>6.2</b> Estimation</a></li>
<li class="chapter" data-level="6.3" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#simulations"><i class="fa fa-check"></i><b>6.3</b> Simulations</a></li>
<li class="chapter" data-level="6.4" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#summarising-simulated-data-in-r"><i class="fa fa-check"></i><b>6.4</b> Summarising simulated data in R</a></li>
<li class="chapter" data-level="6.5" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#posterior-predictive-checks-1"><i class="fa fa-check"></i><b>6.5</b> Posterior predictive checks</a></li>
<li class="chapter" data-level="6.6" data-path="posterior-predictive-checks.html"><a href="posterior-predictive-checks.html#pit-residuals"><i class="fa fa-check"></i><b>6.6</b> PIT residuals</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/NIWAFisheriesModelling/r4Casal2 target="blank">Github Repo here</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">r4Casal2</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="posterior-predictive-checks" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Posterior Predictive Checks<a href="posterior-predictive-checks.html#posterior-predictive-checks" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Introduction<a href="posterior-predictive-checks.html#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This vignette demonstrates how to use Casal2s simulation mode with <code>r4Casal2</code> R functions to generate posterior predictive checks for goodness of fit measures. In terms of assessment workflow, this falls in the Diagnostic component.</p>
<p>The following vignette uses the Casal2 model embedded into this R package. If you want to see where this is on you system paste the following line of code into your R console <code>system.file("extdata", "PosteriorPredictiveChecks", package = "r4Casal2")</code></p>
<div class="figure">
<img src="Figures/assessment_process.png" style="width:50.0%" alt="" />
<p class="caption">Assessment Process</p>
</div>
</div>
<div id="estimation" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Estimation<a href="posterior-predictive-checks.html#estimation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before looking at data goodness of fit you should be checking if the model has converged. We assume that the estimated model has satisfied this criteria i.e. invertable covariance, acceptable gradient (close to zero) and global minima (apposed to local try jittering start values).</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="posterior-predictive-checks.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span></code></pre></div>
<pre><code>## This is DHARMa 0.4.5. For overview type &#39;?DHARMa&#39;. For recent changes, type news(package = &#39;DHARMa&#39;)</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="posterior-predictive-checks.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm) <span class="do">## if simulating obs at MPD</span></span>
<span id="cb53-2"><a href="posterior-predictive-checks.html#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="posterior-predictive-checks.html#cb53-3" aria-hidden="true" tabindex="-1"></a>mpd_file_name <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;PosteriorPredictiveChecks&quot;</span>,<span class="st">&quot;estimate.log&quot;</span>, </span>
<span id="cb53-4"><a href="posterior-predictive-checks.html#cb53-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">package =</span> <span class="st">&quot;r4Casal2&quot;</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-5"><a href="posterior-predictive-checks.html#cb53-5" aria-hidden="true" tabindex="-1"></a>mpd <span class="ot">=</span> <span class="fu">extract.mpd</span>(<span class="at">file =</span> mpd_file_name)</span></code></pre></div>
<pre><code>## WARNING: The output file was generated with a different version than the R libray being used to read the output.
## This may cause compatibility issues. Please update the R package to be consistent with the version of Casal2 used to generate the output.
## The output was generated with Casal2 v(c) 2
## The Casal2 R package is compatible with Casal2 v22.05</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="posterior-predictive-checks.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Report labels</span></span>
<span id="cb55-2"><a href="posterior-predictive-checks.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mpd)</span></code></pre></div>
<pre><code>##  [1] &quot;header&quot;               &quot;obj&quot;                  &quot;estimate_summary&quot;    
##  [4] &quot;covar&quot;                &quot;hess&quot;                 &quot;estimate_value&quot;      
##  [7] &quot;biomass_t1&quot;           &quot;chatOBSest&quot;           &quot;chatOBSwst&quot;          
## [10] &quot;chatTANage&quot;           &quot;chatTANbiomass&quot;       &quot;Recruitment&quot;         
## [13] &quot;Ageing&quot;               &quot;instant_mort&quot;         &quot;MaturationSel&quot;       
## [16] &quot;westFSel&quot;             &quot;eastFSel&quot;             &quot;chatTANSel&quot;          
## [19] &quot;One&quot;                  &quot;messages_encountered&quot;</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="posterior-predictive-checks.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is covariance symetric</span></span>
<span id="cb57-2"><a href="posterior-predictive-checks.html#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">isSymmetric</span>(mpd<span class="sc">$</span>covar<span class="sc">$</span>covariance_matrix)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="posterior-predictive-checks.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is hessian invertable</span></span>
<span id="cb59-2"><a href="posterior-predictive-checks.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">is_matrix_invertable</span>(mpd<span class="sc">$</span>hess<span class="sc">$</span>hessian_matrix)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="simulations" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Simulations<a href="posterior-predictive-checks.html#simulations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The first thing you should do is add reports of type <code>simulated_observation</code> for each observation in your Casal2 configuration files. The helper function <code>?create_simulation_reports</code> will automatically generate a casal2 compatible reports to a file named <code>simulated_reports.csl2</code> containing all simulated observations in your configuration files. If you use this function you will need to then add an include statement into your Casal2 config files i.e. <code>!include simulated_reports.csl2</code> before running casal2 in simulation mode <code>casal2 -s 1</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="posterior-predictive-checks.html#cb61-1" aria-hidden="true" tabindex="-1"></a>config_dir <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;PosteriorPredictiveChecks&quot;</span>, <span class="at">package =</span> <span class="st">&quot;r4Casal2&quot;</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-2"><a href="posterior-predictive-checks.html#cb61-2" aria-hidden="true" tabindex="-1"></a>config_files <span class="ot">=</span> <span class="st">&quot;Observation.csl2&quot;</span></span>
<span id="cb61-3"><a href="posterior-predictive-checks.html#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="do">## this will create the file &#39;simulated_reports.csl2&#39; in config_dir</span></span>
<span id="cb61-4"><a href="posterior-predictive-checks.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="do">## in addition to creating the directory labelled output_folder</span></span>
<span id="cb61-5"><a href="posterior-predictive-checks.html#cb61-5" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">=</span> <span class="fu">create_simulation_reports</span>(<span class="at">config_dir =</span> config_dir, <span class="at">config_files =</span> config_files,</span>
<span id="cb61-6"><a href="posterior-predictive-checks.html#cb61-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">output_folder =</span> <span class="st">&quot;simulated_observations&quot;</span>)</span>
<span id="cb61-7"><a href="posterior-predictive-checks.html#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="do">## append include statement </span></span>
<span id="cb61-8"><a href="posterior-predictive-checks.html#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>)</span>
<span id="cb61-9"><a href="posterior-predictive-checks.html#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;!include simulated_reports.csl2&quot;</span>, <span class="at">file =</span> </span>
<span id="cb61-10"><a href="posterior-predictive-checks.html#cb61-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">file.path</span>(config_dir, <span class="st">&quot;config.csl2&quot;</span>), <span class="at">append =</span> T)</span>
<span id="cb61-11"><a href="posterior-predictive-checks.html#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="do">## run Casal2 -s</span></span>
<span id="cb61-12"><a href="posterior-predictive-checks.html#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co"># system(paste0(&quot;cd &quot;, config_dir, &quot;; casal2 -s 100 -i pars&quot; ))</span></span></code></pre></div>
<p>If you don’t have these reports in your configuration files, Casal2 will not save simulated observations. Tips when specifying this report class</p>
<ol style="list-style-type: decimal">
<li>Save each simulated observation into a seperate <code>file_name</code></li>
<li>Create a directory to save simulated data sets in.</li>
<li>Have the report label the same as the <code>file_name</code> (see example below)</li>
<li>Avoid haveing periods/dots (“.”) in <code>file_name</code></li>
</ol>
<p>An example report structure would look like</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="posterior-predictive-checks.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">@report</span> sim_chatTANage</span>
<span id="cb62-2"><a href="posterior-predictive-checks.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> simulated_observation</span>
<span id="cb62-3"><a href="posterior-predictive-checks.html#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="ex">observation</span> chatTANage</span>
<span id="cb62-4"><a href="posterior-predictive-checks.html#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="ex">file_name</span> simulated_observations/sim_chatTANage</span></code></pre></div>
<p>There are three variants of simulations you can conduct in Casal2, and these depend on if you are in MPD or MCMC estimation phase. If you are evaluating a MPD run, there are two variants and depend if you want to account for parameter uncertainty or not. If you don’t want parameter uncertainty, then you need to run the following Casal2 command to produce 100 sets of simulations <code>casal2 -s 100 -i mpd_pars.log &gt; simulate.log</code>. If you want to account for parameter uncertainty then you can use a multivariant normal distribution with mean equal to MPD and resulting covariance to produce a set of simulations, example below.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="posterior-predictive-checks.html#cb63-1" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb63-2"><a href="posterior-predictive-checks.html#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="do">## </span><span class="al">NOTE</span><span class="do">: might have issue with bounds assuming normal dist</span></span>
<span id="cb63-3"><a href="posterior-predictive-checks.html#cb63-3" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">=</span> <span class="fu">rmvnorm</span>(<span class="at">n =</span> n_sims, <span class="at">mean =</span> <span class="fu">as.numeric</span>(mpd<span class="sc">$</span>estimate_value<span class="sc">$</span>values), </span>
<span id="cb63-4"><a href="posterior-predictive-checks.html#cb63-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">sigma =</span> mpd<span class="sc">$</span>covar<span class="sc">$</span>covariance_matrix)</span>
<span id="cb63-5"><a href="posterior-predictive-checks.html#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(sims)</span></code></pre></div>
<pre><code>## [1] 1000   46</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="posterior-predictive-checks.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sims) <span class="ot">=</span> <span class="fu">names</span>(mpd<span class="sc">$</span>estimate_value<span class="sc">$</span>values)</span>
<span id="cb65-2"><a href="posterior-predictive-checks.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="do">## save simulated pars in the same directory as your</span></span>
<span id="cb65-3"><a href="posterior-predictive-checks.html#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="do">## CSL files</span></span>
<span id="cb65-4"><a href="posterior-predictive-checks.html#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="cn">FALSE</span>)</span>
<span id="cb65-5"><a href="posterior-predictive-checks.html#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(sims, <span class="at">file =</span> <span class="st">&quot;mpd_mvnorm_pars.csl2&quot;</span>, <span class="at">quote =</span> F, <span class="at">row.names =</span> F, <span class="at">col.names =</span> T)</span>
<span id="cb65-6"><a href="posterior-predictive-checks.html#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run </span></span>
<span id="cb65-7"><a href="posterior-predictive-checks.html#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># casal2 -s 1 -i mpd_mvnorm_pars.csl2 &gt; simulate.log</span></span></code></pre></div>
</div>
<div id="summarising-simulated-data-in-r" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Summarising simulated data in R<a href="posterior-predictive-checks.html#summarising-simulated-data-in-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Assuming you have saved all the simulated observations as separate files in a standalone folder.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="posterior-predictive-checks.html#cb66-1" aria-hidden="true" tabindex="-1"></a>sim_dir <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;PosteriorPredictiveChecks&quot;</span>,<span class="st">&quot;simulated_observations&quot;</span>, </span>
<span id="cb66-2"><a href="posterior-predictive-checks.html#cb66-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">package =</span> <span class="st">&quot;r4Casal2&quot;</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-3"><a href="posterior-predictive-checks.html#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="posterior-predictive-checks.html#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="do">## created from running simulations and reading them in with</span></span>
<span id="cb66-5"><a href="posterior-predictive-checks.html#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sim_vals = read.simulated.data(dir = sim_dir, mean_age = F)</span></span>
<span id="cb66-6"><a href="posterior-predictive-checks.html#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(sim_vals, file.path(&quot;sim_vals.RDS&quot;))</span></span>
<span id="cb66-7"><a href="posterior-predictive-checks.html#cb66-7" aria-hidden="true" tabindex="-1"></a>sim_vals <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(sim_dir, <span class="st">&quot;sim_vals.RDS&quot;</span>))</span>
<span id="cb66-8"><a href="posterior-predictive-checks.html#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="posterior-predictive-checks.html#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># check no trouble with files</span></span>
<span id="cb66-10"><a href="posterior-predictive-checks.html#cb66-10" aria-hidden="true" tabindex="-1"></a>sim_vals<span class="sc">$</span>failed_files</span></code></pre></div>
<pre><code>## logical(0)</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="posterior-predictive-checks.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb68-2"><a href="posterior-predictive-checks.html#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_vals<span class="sc">$</span>sim_obs)</span></code></pre></div>
<pre><code>## [1] &quot;sim_chatOBSest&quot;     &quot;sim_chatOBSwst&quot;     &quot;sim_chatTANage&quot;    
## [4] &quot;sim_chatTANbiomass&quot;</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="posterior-predictive-checks.html#cb70-1" aria-hidden="true" tabindex="-1"></a>sim_dir_alt <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;PosteriorPredictiveChecks&quot;</span>,<span class="st">&quot;simulated_observations_no_param_var&quot;</span>, </span>
<span id="cb70-2"><a href="posterior-predictive-checks.html#cb70-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">package =</span> <span class="st">&quot;r4Casal2&quot;</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-3"><a href="posterior-predictive-checks.html#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="posterior-predictive-checks.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#sim_vals_alt = read.simulated.data(dir = sim_dir_alt, mean_age = F)</span></span>
<span id="cb70-5"><a href="posterior-predictive-checks.html#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">#saveRDS(sim_vals_alt, file.path(&quot;sim_vals_alt.RDS&quot;))</span></span>
<span id="cb70-6"><a href="posterior-predictive-checks.html#cb70-6" aria-hidden="true" tabindex="-1"></a>sim_vals_alt <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(sim_dir_alt, <span class="st">&quot;sim_vals_alt.RDS&quot;</span>))</span>
<span id="cb70-7"><a href="posterior-predictive-checks.html#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="posterior-predictive-checks.html#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check no trouble with reading in files</span></span>
<span id="cb70-9"><a href="posterior-predictive-checks.html#cb70-9" aria-hidden="true" tabindex="-1"></a>sim_vals_alt<span class="sc">$</span>failed_files</span></code></pre></div>
<pre><code>## logical(0)</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="posterior-predictive-checks.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb72-2"><a href="posterior-predictive-checks.html#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_vals_alt<span class="sc">$</span>sim_obs)</span></code></pre></div>
<pre><code>## [1] &quot;sim_chatOBSest&quot;     &quot;sim_chatOBSwst&quot;     &quot;sim_chatTANage&quot;    
## [4] &quot;sim_chatTANbiomass&quot;</code></pre>
</div>
<div id="posterior-predictive-checks-1" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Posterior predictive checks<a href="posterior-predictive-checks.html#posterior-predictive-checks-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once simulated data has been read into the R environment, we want to compare where the observed values fall relative to the posterior predictive distributions. We recommend using the DHarma r package for this. To intepret P-values or understand the test-statistics that DHARMa does copy this into your R console <code>vignette("DHARMa", package="DHARMa")</code> (Assuming you have installed this package).</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="posterior-predictive-checks.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Create DHARMa objects and P-values</span></span>
<span id="cb74-2"><a href="posterior-predictive-checks.html#cb74-2" aria-hidden="true" tabindex="-1"></a>DHARMaResbio <span class="ot">=</span> <span class="fu">createDHARMa</span>(<span class="at">simulatedResponse =</span> sim_vals<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANbiomass, </span>
<span id="cb74-3"><a href="posterior-predictive-checks.html#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">observedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>observed, </span>
<span id="cb74-4"><a href="posterior-predictive-checks.html#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fittedPredictedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>expected, <span class="at">integerResponse =</span> F)</span>
<span id="cb74-5"><a href="posterior-predictive-checks.html#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Create DHARMa objects and P-values</span></span>
<span id="cb74-6"><a href="posterior-predictive-checks.html#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="do">## for AF </span></span>
<span id="cb74-7"><a href="posterior-predictive-checks.html#cb74-7" aria-hidden="true" tabindex="-1"></a>mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>numbers_at_age <span class="ot">=</span> mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>observed <span class="sc">*</span> mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>error_value</span>
<span id="cb74-8"><a href="posterior-predictive-checks.html#cb74-8" aria-hidden="true" tabindex="-1"></a>year <span class="ot">=</span> <span class="dv">1999</span></span>
<span id="cb74-9"><a href="posterior-predictive-checks.html#cb74-9" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">=</span> mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>numbers_at_age[mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>year <span class="sc">==</span> year]</span>
<span id="cb74-10"><a href="posterior-predictive-checks.html#cb74-10" aria-hidden="true" tabindex="-1"></a>DHARMaResAF <span class="ot">=</span> <span class="fu">createDHARMa</span>(<span class="at">simulatedResponse =</span> sim_vals<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANage[[<span class="fu">as.character</span>(year)]], <span class="at">observedResponse =</span> obs, </span>
<span id="cb74-11"><a href="posterior-predictive-checks.html#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">fittedPredictedResponse =</span> <span class="cn">NULL</span>, <span class="at">integerResponse =</span> F)</span></code></pre></div>
<pre><code>## No fitted predicted response provided, using the mean of the simulations</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="posterior-predictive-checks.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="do">## use DHARMa functions</span></span>
<span id="cb76-2"><a href="posterior-predictive-checks.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DHARMaResbio, <span class="at">quantreg =</span> F)</span></code></pre></div>
<p><img src="_main_files/figure-html/ppp-1.png" width="768" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="posterior-predictive-checks.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DHARMaResAF, <span class="at">quantreg =</span> F)</span></code></pre></div>
<p><img src="_main_files/figure-html/ppp-2.png" width="768" /></p>
<p>Examples of custom plots</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="posterior-predictive-checks.html#cb78-1" aria-hidden="true" tabindex="-1"></a>sim_chatTANbiomass <span class="ot">=</span> sim_vals<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANbiomass</span>
<span id="cb78-2"><a href="posterior-predictive-checks.html#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sim_chatTANbiomass) <span class="ot">=</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>year</span>
<span id="cb78-3"><a href="posterior-predictive-checks.html#cb78-3" aria-hidden="true" tabindex="-1"></a>DHARMaResbio_quant_resids <span class="ot">=</span> <span class="fu">createDHARMa</span>(<span class="at">simulatedResponse =</span> sim_chatTANbiomass, </span>
<span id="cb78-4"><a href="posterior-predictive-checks.html#cb78-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">observedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>observed, </span>
<span id="cb78-5"><a href="posterior-predictive-checks.html#cb78-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fittedPredictedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>expected, <span class="at">integerResponse =</span> F)</span>
<span id="cb78-6"><a href="posterior-predictive-checks.html#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="do">## convert from uniform variable -&gt; standard normal</span></span>
<span id="cb78-7"><a href="posterior-predictive-checks.html#cb78-7" aria-hidden="true" tabindex="-1"></a>norm_quant_resids <span class="ot">=</span> <span class="fu">qnorm</span>(DHARMaResbio_quant_resids<span class="sc">$</span>scaledResiduals)</span>
<span id="cb78-8"><a href="posterior-predictive-checks.html#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="co"># formal tests</span></span>
<span id="cb78-9"><a href="posterior-predictive-checks.html#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="co">#dispersion_test = testDispersion(DHARMaResbio_quant_resids)</span></span>
<span id="cb78-10"><a href="posterior-predictive-checks.html#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="co">#zero_inflat_test = testZeroInflation(DHARMaResbio_quant_resids)</span></span>
<span id="cb78-11"><a href="posterior-predictive-checks.html#cb78-11" aria-hidden="true" tabindex="-1"></a>temporal_correlation <span class="ot">=</span> <span class="fu">testTemporalAutocorrelation</span>(<span class="at">simulationOutput =</span> DHARMaResbio_quant_resids, <span class="at">time =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>year, <span class="at">plot =</span> F) <span class="do">## HO: rho = 0, HA: rho != 0</span></span>
<span id="cb78-12"><a href="posterior-predictive-checks.html#cb78-12" aria-hidden="true" tabindex="-1"></a>temporal_correlation</span></code></pre></div>
<pre><code>## 
##  Durbin-Watson test
## 
## data:  simulationOutput$scaledResiduals ~ 1
## DW = 1.9861, p-value = 0.9743
## alternative hypothesis: true autocorrelation is not 0</code></pre>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="posterior-predictive-checks.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot posterior predictive checks</span></span>
<span id="cb80-2"><a href="posterior-predictive-checks.html#cb80-2" aria-hidden="true" tabindex="-1"></a>bioplt <span class="ot">=</span> <span class="fu">plot_abundance_predictive_dist</span>(<span class="at">sim_data =</span> sim_chatTANbiomass, </span>
<span id="cb80-3"><a href="posterior-predictive-checks.html#cb80-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">obs =</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>observed, </span>
<span id="cb80-4"><a href="posterior-predictive-checks.html#cb80-4" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">year =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>year,</span>
<span id="cb80-5"><a href="posterior-predictive-checks.html#cb80-5" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">mpd_fit =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>expected),</span>
<span id="cb80-6"><a href="posterior-predictive-checks.html#cb80-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">lab =</span> <span class="st">&quot;&quot;</span>, <span class="at">plot_type =</span> <span class="st">&quot;violin&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
## collapsing to unique &#39;x&#39; values</code></pre>
<p><img src="_main_files/figure-html/custom_figures-1.png" width="768" /></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="posterior-predictive-checks.html#cb82-1" aria-hidden="true" tabindex="-1"></a>bioplt<span class="ot">=</span> bioplt <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>)) <span class="sc">+</span></span>
<span id="cb82-2"><a href="posterior-predictive-checks.html#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;MPD Predictive distributions&quot;</span>)</span>
<span id="cb82-3"><a href="posterior-predictive-checks.html#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="do">## qq plot for simulated quantile residuals.</span></span>
<span id="cb82-4"><a href="posterior-predictive-checks.html#cb82-4" aria-hidden="true" tabindex="-1"></a>norm_resid <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">resids =</span> norm_quant_resids), <span class="fu">aes</span>(<span class="at">sample =</span> resids)) <span class="sc">+</span></span>
<span id="cb82-5"><a href="posterior-predictive-checks.html#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb82-6"><a href="posterior-predictive-checks.html#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">col =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-7"><a href="posterior-predictive-checks.html#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Theoretical&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sample&quot;</span>)</span>
<span id="cb82-8"><a href="posterior-predictive-checks.html#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot normalised residuals generated from Casal2</span></span>
<span id="cb82-9"><a href="posterior-predictive-checks.html#cb82-9" aria-hidden="true" tabindex="-1"></a>normalised_resids <span class="ot">=</span> <span class="fu">ggplot</span>(mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values, <span class="fu">aes</span>(<span class="at">sample =</span> normalised_residuals)) <span class="sc">+</span></span>
<span id="cb82-10"><a href="posterior-predictive-checks.html#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb82-11"><a href="posterior-predictive-checks.html#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">col =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-12"><a href="posterior-predictive-checks.html#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Theoretical&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sample&quot;</span>)</span>
<span id="cb82-13"><a href="posterior-predictive-checks.html#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot fits obs</span></span>
<span id="cb82-14"><a href="posterior-predictive-checks.html#cb82-14" aria-hidden="true" tabindex="-1"></a>fits <span class="ot">=</span> <span class="fu">plot.relative_index</span>(<span class="at">model =</span> mpd, <span class="at">report_label =</span> <span class="st">&quot;chatTANbiomass&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb82-15"><a href="posterior-predictive-checks.html#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb82-16"><a href="posterior-predictive-checks.html#cb82-16" aria-hidden="true" tabindex="-1"></a>fits</span></code></pre></div>
<p><img src="_main_files/figure-html/custom_figures-2.png" width="768" /></p>
<p>Look at Predictive checks when generated with variability in parameter estimates as well.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="posterior-predictive-checks.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Create DHARMa objects and P-values</span></span>
<span id="cb83-2"><a href="posterior-predictive-checks.html#cb83-2" aria-hidden="true" tabindex="-1"></a>DHARMaResbio <span class="ot">=</span> <span class="fu">createDHARMa</span>(<span class="at">simulatedResponse =</span> sim_vals_alt<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANbiomass, </span>
<span id="cb83-3"><a href="posterior-predictive-checks.html#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">observedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>observed, </span>
<span id="cb83-4"><a href="posterior-predictive-checks.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fittedPredictedResponse =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>expected, <span class="at">integerResponse =</span> F)</span>
<span id="cb83-5"><a href="posterior-predictive-checks.html#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Create DHARMa objects and P-values</span></span>
<span id="cb83-6"><a href="posterior-predictive-checks.html#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="do">## for AF </span></span>
<span id="cb83-7"><a href="posterior-predictive-checks.html#cb83-7" aria-hidden="true" tabindex="-1"></a>year <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb83-8"><a href="posterior-predictive-checks.html#cb83-8" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">=</span> mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>numbers_at_age[mpd<span class="sc">$</span>chatTANage<span class="sc">$</span>Values<span class="sc">$</span>year <span class="sc">==</span> year]</span>
<span id="cb83-9"><a href="posterior-predictive-checks.html#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="posterior-predictive-checks.html#cb83-10" aria-hidden="true" tabindex="-1"></a>DHARMaResAF <span class="ot">=</span> <span class="fu">createDHARMa</span>(<span class="at">simulatedResponse =</span> sim_vals_alt<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANage[[<span class="fu">as.character</span>(year)]], <span class="at">observedResponse =</span> obs, </span>
<span id="cb83-11"><a href="posterior-predictive-checks.html#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">fittedPredictedResponse =</span> <span class="cn">NULL</span>, <span class="at">integerResponse =</span> T)</span></code></pre></div>
<pre><code>## No fitted predicted response provided, using the mean of the simulations</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="posterior-predictive-checks.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DHARMaResbio, <span class="at">quantreg =</span> F)</span></code></pre></div>
<p><img src="_main_files/figure-html/ppp_no_param_var-1.png" width="768" /></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="posterior-predictive-checks.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DHARMaResAF, <span class="at">quantreg =</span> F)</span></code></pre></div>
<p><img src="_main_files/figure-html/ppp_no_param_var-2.png" width="768" /></p>
<p>Some other visualizations plots</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="posterior-predictive-checks.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="do">########################</span></span>
<span id="cb87-2"><a href="posterior-predictive-checks.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="do">## boxplot predictive distribution vs observation</span></span>
<span id="cb87-3"><a href="posterior-predictive-checks.html#cb87-3" aria-hidden="true" tabindex="-1"></a>legend <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;Posterior Prediction&quot;</span> <span class="ot">=</span> <span class="st">&quot;#56B4E9&quot;</span>, <span class="st">&quot;Observation&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span> , <span class="st">&quot;MPD&quot;</span> <span class="ot">=</span> <span class="st">&quot;#D55E00&quot;</span>)</span>
<span id="cb87-4"><a href="posterior-predictive-checks.html#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="posterior-predictive-checks.html#cb87-5" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">=</span> sim_vals<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANbiomass</span>
<span id="cb87-6"><a href="posterior-predictive-checks.html#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sim_data) <span class="ot">=</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>year</span>
<span id="cb87-7"><a href="posterior-predictive-checks.html#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="posterior-predictive-checks.html#cb87-8" aria-hidden="true" tabindex="-1"></a>bioplt <span class="ot">=</span> <span class="fu">plot_abundance_predictive_dist</span>(<span class="at">sim_data =</span> sim_data, </span>
<span id="cb87-9"><a href="posterior-predictive-checks.html#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">obs =</span> <span class="fu">data.frame</span>(<span class="at">obs =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>observed, </span>
<span id="cb87-10"><a href="posterior-predictive-checks.html#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>year,</span>
<span id="cb87-11"><a href="posterior-predictive-checks.html#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mpd_fit =</span> mpd<span class="sc">$</span>chatTANbiomass<span class="sc">$</span>Values<span class="sc">$</span>expected), </span>
<span id="cb87-12"><a href="posterior-predictive-checks.html#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lab =</span> <span class="st">&quot;chatTANbiomass&quot;</span>, <span class="at">plot_type =</span> <span class="st">&quot;violin&quot;</span>)</span></code></pre></div>
<pre><code>## Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
## collapsing to unique &#39;x&#39; values</code></pre>
<p><img src="_main_files/figure-html/ggplots_ppp-1.png" width="768" /></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="posterior-predictive-checks.html#cb89-1" aria-hidden="true" tabindex="-1"></a>chat_sim_vals <span class="ot">=</span> <span class="fu">get_simulated_age_resids</span>(sim_vals<span class="sc">$</span>sim_obs<span class="sc">$</span>sim_chatTANage, mpd<span class="sc">$</span>chatTANage)</span>
<span id="cb89-2"><a href="posterior-predictive-checks.html#cb89-2" aria-hidden="true" tabindex="-1"></a>obs_years <span class="ot">=</span> <span class="fu">unique</span>(chat_sim_vals<span class="sc">$</span>mpd_df<span class="sc">$</span>year)</span>
<span id="cb89-3"><a href="posterior-predictive-checks.html#cb89-3" aria-hidden="true" tabindex="-1"></a>years_to_plot <span class="ot">=</span> obs_years[<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>]</span>
<span id="cb89-4"><a href="posterior-predictive-checks.html#cb89-4" aria-hidden="true" tabindex="-1"></a>pppAFplt_1 <span class="ot">=</span>  <span class="fu">ggplot</span>(chat_sim_vals<span class="sc">$</span>full_simulated_values <span class="sc">%&gt;%</span> </span>
<span id="cb89-5"><a href="posterior-predictive-checks.html#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">%in%</span> years_to_plot), <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(age, <span class="at">ordered =</span> T), <span class="at">y =</span> simulated_value)) <span class="sc">+</span></span>
<span id="cb89-6"><a href="posterior-predictive-checks.html#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">&quot;Posterior Prediction&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;Posterior Prediction&quot;</span>),<span class="at">adjust=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb89-7"><a href="posterior-predictive-checks.html#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> legend) <span class="sc">+</span></span>
<span id="cb89-8"><a href="posterior-predictive-checks.html#cb89-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb89-9"><a href="posterior-predictive-checks.html#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>)) <span class="sc">+</span></span>
<span id="cb89-10"><a href="posterior-predictive-checks.html#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">colour =</span> <span class="st">&quot;Legend&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Age&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Posterior Predictive Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb89-11"><a href="posterior-predictive-checks.html#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> chat_sim_vals<span class="sc">$</span>mpd_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> years_to_plot), <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(age, <span class="at">ordered =</span> T), <span class="at">y =</span> observed <span class="sc">*</span> error_value, <span class="at">color =</span> <span class="st">&quot;Observation&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;Observation&quot;</span>), <span class="at">size =</span> <span class="fl">2.4</span>, <span class="at">inherit.aes =</span> F ) <span class="sc">+</span></span>
<span id="cb89-12"><a href="posterior-predictive-checks.html#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">ncol =</span> <span class="dv">3</span>)    <span class="sc">+</span></span>
<span id="cb89-13"><a href="posterior-predictive-checks.html#cb89-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;chatTANage&quot;</span>)</span>
<span id="cb89-14"><a href="posterior-predictive-checks.html#cb89-14" aria-hidden="true" tabindex="-1"></a>pppAFplt_1</span></code></pre></div>
<p><img src="_main_files/figure-html/ggplots_ppp-2.png" width="768" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="posterior-predictive-checks.html#cb90-1" aria-hidden="true" tabindex="-1"></a>OM_file <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;PosteriorPredictiveChecks&quot;</span>,<span class="st">&quot;OM&quot;</span>,<span class="st">&quot;OM_vary.log&quot;</span>, <span class="at">package =</span> <span class="st">&quot;r4Casal2&quot;</span>, <span class="at">mustWork =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-2"><a href="posterior-predictive-checks.html#cb90-2" aria-hidden="true" tabindex="-1"></a>OM_run <span class="ot">=</span> <span class="fu">extract.mpd</span>(<span class="at">file =</span> OM_file)</span></code></pre></div>
<pre><code>## WARNING: The output file was generated with a different version than the R libray being used to read the output.
## This may cause compatibility issues. Please update the R package to be consistent with the version of Casal2 used to generate the output.
## The output was generated with Casal2 v(c) 2
## The Casal2 R package is compatible with Casal2 v22.05
## 
## loading a Casal2 output from a multi parameter input format
## loading a Casal2 output from a multi parameter input format</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="posterior-predictive-checks.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot SSBs</span></span>
<span id="cb92-2"><a href="posterior-predictive-checks.html#cb92-2" aria-hidden="true" tabindex="-1"></a>my_plot <span class="ot">=</span> r4Casal2<span class="sc">::</span><span class="fu">plot.derived_quantities</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="at">OM =</span> OM_run, <span class="at">EM =</span> mpd), <span class="at">report_label =</span> <span class="st">&quot;biomass_t1&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;multi iteration report found&quot;</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="posterior-predictive-checks.html#cb94-1" aria-hidden="true" tabindex="-1"></a>my_plot <span class="ot">=</span> my_plot <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;SSB&quot;</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">120000</span>)</span></code></pre></div>
</div>
<div id="pit-residuals" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> PIT residuals<a href="posterior-predictive-checks.html#pit-residuals" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Pearson residuals for multinomial distributed random variables can be difficult to intepret for a lot of reasons, data-weighting for mean age to standardised residuals = 1 <span class="citation">(<a href="#ref-francis2011data" role="doc-biblioref">Francis 2011</a>)</span>, sparsity can create funny patterns etc. An alternative is to use randomised quantile PIT residuals <span class="citation">(<a href="#ref-warton2017pit" role="doc-biblioref">Warton, Thibaut, and Wang 2017</a>; <a href="#ref-dunn1996randomized" role="doc-biblioref">Dunn and Smyth 1996</a>)</span></p>
<p>Assuming we have data denoted by <span class="math inline">\(y\)</span> which has cumulative distribution function <span class="math inline">\(F(y; \theta), u = F(y; \theta) \sim Uniform(0,1)\)</span>. For discrete variables the following adjustment can be made
<span class="math display">\[\begin{align}
u_i = q_i F(y; \theta) + (1 - q_i) F(y^{-}; \theta) 
\end{align}\]</span>
where, <span class="math inline">\(q_i\)</span> is a standard uniform random variable and <span class="math inline">\(y^{-}\)</span> is the previous allowable value for <span class="math inline">\(y\)</span>.
they do not behave like residuals in the usual sense they are centred around a value of 0.5 rather than a value of 0, and are bounded between 0 and 1.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="posterior-predictive-checks.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hello</span></span>
<span id="cb95-2"><a href="posterior-predictive-checks.html#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb95-3"><a href="posterior-predictive-checks.html#cb95-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb95-4"><a href="posterior-predictive-checks.html#cb95-4" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb95-5"><a href="posterior-predictive-checks.html#cb95-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(n, <span class="dv">5</span>, <span class="dv">3</span>)</span>
<span id="cb95-6"><a href="posterior-predictive-checks.html#cb95-6" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">=</span> <span class="dv">3</span></span>
<span id="cb95-7"><a href="posterior-predictive-checks.html#cb95-7" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">=</span> <span class="fl">1.2</span></span>
<span id="cb95-8"><a href="posterior-predictive-checks.html#cb95-8" aria-hidden="true" tabindex="-1"></a>true_beta1 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb95-9"><a href="posterior-predictive-checks.html#cb95-9" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rpois</span>(n, beta0 <span class="sc">+</span> true_beta1 <span class="sc">*</span> x)</span>
<span id="cb95-10"><a href="posterior-predictive-checks.html#cb95-10" aria-hidden="true" tabindex="-1"></a>y_sim <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n, <span class="at">ncol =</span> nsims) </span>
<span id="cb95-11"><a href="posterior-predictive-checks.html#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nsims)</span>
<span id="cb95-12"><a href="posterior-predictive-checks.html#cb95-12" aria-hidden="true" tabindex="-1"></a>  y_sim[,i] <span class="ot">=</span> <span class="fu">rpois</span>(n, beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> x)</span>
<span id="cb95-13"><a href="posterior-predictive-checks.html#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate PIT</span></span>
<span id="cb95-14"><a href="posterior-predictive-checks.html#cb95-14" aria-hidden="true" tabindex="-1"></a>PITResiduals <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n)</span>
<span id="cb95-15"><a href="posterior-predictive-checks.html#cb95-15" aria-hidden="true" tabindex="-1"></a>altPITResiduals <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n)</span>
<span id="cb95-16"><a href="posterior-predictive-checks.html#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb95-17"><a href="posterior-predictive-checks.html#cb95-17" aria-hidden="true" tabindex="-1"></a>  minSim <span class="ot">&lt;-</span> <span class="fu">mean</span>(y_sim[i,] <span class="sc">&lt;</span> y[i]) </span>
<span id="cb95-18"><a href="posterior-predictive-checks.html#cb95-18" aria-hidden="true" tabindex="-1"></a>  maxSim <span class="ot">&lt;-</span> <span class="fu">mean</span>(y_sim[i,] <span class="sc">&lt;=</span> y[i]) </span>
<span id="cb95-19"><a href="posterior-predictive-checks.html#cb95-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (minSim <span class="sc">==</span> maxSim) {</span>
<span id="cb95-20"><a href="posterior-predictive-checks.html#cb95-20" aria-hidden="true" tabindex="-1"></a>    PITResiduals[i] <span class="ot">=</span> minSim</span>
<span id="cb95-21"><a href="posterior-predictive-checks.html#cb95-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb95-22"><a href="posterior-predictive-checks.html#cb95-22" aria-hidden="true" tabindex="-1"></a>    PITResiduals[i] <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>, minSim, maxSim)</span>
<span id="cb95-23"><a href="posterior-predictive-checks.html#cb95-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-24"><a href="posterior-predictive-checks.html#cb95-24" aria-hidden="true" tabindex="-1"></a>  qi <span class="ot">=</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb95-25"><a href="posterior-predictive-checks.html#cb95-25" aria-hidden="true" tabindex="-1"></a>  lower_limit <span class="ot">=</span> <span class="fu">mean</span>(y_sim[i,] <span class="sc">&lt;</span> y[i])</span>
<span id="cb95-26"><a href="posterior-predictive-checks.html#cb95-26" aria-hidden="true" tabindex="-1"></a>  cum_ecdf <span class="ot">=</span> <span class="fu">mean</span>(y_sim[i,] <span class="sc">&lt;=</span> y[i])</span>
<span id="cb95-27"><a href="posterior-predictive-checks.html#cb95-27" aria-hidden="true" tabindex="-1"></a>  altPITResiduals[i] <span class="ot">=</span> qi <span class="sc">*</span> cum_ecdf <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> qi) <span class="sc">*</span> lower_limit</span>
<span id="cb95-28"><a href="posterior-predictive-checks.html#cb95-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-29"><a href="posterior-predictive-checks.html#cb95-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(PITResiduals, altPITResiduals)</span></code></pre></div>
<p><img src="_main_files/figure-html/illustrate_PIT-1.png" width="672" /></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="posterior-predictive-checks.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># It is assumed that PIT resiudals are from uniform(0,1)</span></span>
<span id="cb96-2"><a href="posterior-predictive-checks.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># most people transform them to normal distribution for testing</span></span>
<span id="cb96-3"><a href="posterior-predictive-checks.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># for familiarity more than anything.</span></span>
<span id="cb96-4"><a href="posterior-predictive-checks.html#cb96-4" aria-hidden="true" tabindex="-1"></a>normal_transformed <span class="ot">=</span> <span class="fu">qnorm</span>(PITResiduals)</span>
<span id="cb96-5"><a href="posterior-predictive-checks.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(normal_transformed)</span>
<span id="cb96-6"><a href="posterior-predictive-checks.html#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(normal_transformed, <span class="at">col =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/illustrate_PIT-2.png" width="672" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="posterior-predictive-checks.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(normal_transformed)</span></code></pre></div>
<pre><code>## 
##  Shapiro-Wilk normality test
## 
## data:  normal_transformed
## W = 0.97169, p-value = 0.2707</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="posterior-predictive-checks.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># From the output, the p-value &gt; 0.05 implying that the distribution </span></span>
<span id="cb99-2"><a href="posterior-predictive-checks.html#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># of the data are not significantly different from normal distribution. </span></span>
<span id="cb99-3"><a href="posterior-predictive-checks.html#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># In other words, we can assume the normality.</span></span></code></pre></div>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-dunn1996randomized" class="csl-entry">
Dunn, Peter K, and Gordon K Smyth. 1996. <span>“Randomized Quantile Residuals.”</span> <em>Journal of Computational and Graphical Statistics</em> 5 (3): 236–44.
</div>
<div id="ref-francis2011data" class="csl-entry">
Francis, RIC Chris. 2011. <span>“Data Weighting in Statistical Fisheries Stock Assessment Models.”</span> <em>Canadian Journal of Fisheries and Aquatic Sciences</em> 68 (6): 1124–38.
</div>
<div id="ref-warton2017pit" class="csl-entry">
Warton, David I, Loı̈c Thibaut, and Yi Alice Wang. 2017. <span>“The PIT-Trap—a <span>‘Model-Free’</span> Bootstrap Procedure for Inference about Regression Models with Discrete, Multivariate Responses.”</span> <em>PloS One</em> 12 (7): e0181790.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mcmc.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/NIWAFisheriesModelling/r4Casal2/edit/main/06-PosteriorPredictiveChecks.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
